<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%220.9em%22  font-size=%2290%22>🐠</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✔我的待办</title>
    <style>
        #calendarViewBtn {
            width: 100%;
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #FF4351;
            border-radius: 2px; /* 圆角效果 */
            box-shadow: 0 0 0 2px black; /* 模拟 outline */
            color: white;
            border: none;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            font-family: sans-serif;
        }
        
        #calendarViewBtn:hover {
            background-color: #ff7680; /* 和 + 按钮一样的悬停效果 */
        }
        
        .status {

    font-size: 14px;
    text-align: right;
    padding-top: 10px;

}
        
        
        body {
            font-family: sans-serif;
                max-width: 720px; /* 最大宽度 */
            margin: 25px auto;    /* 水平居中 */
            padding: 0 20px;   /* 内边距，防止内容紧贴边缘 */
        }
        
        
        
        .date-nav {
            border-radius: 2px; /* 圆角效果 */
            box-shadow: 0 0 0 2px black; /* 模拟 outline */
    display: flex;
    flex-direction: column; /* 垂直排列年份和日期导航 */
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: #fec04e;
    color: #221f1f;
}

.year-line {
    font-weight: bold;
    font-size: 12px;
    align-self: baseline;
}

.date-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%; /* 使箭头和日期导航居中分布 */
}

.arrow {
    cursor: pointer;
    font-size: 20px;
    padding: 0 10px;
}

.days {
    display: flex;
            justify-content: space-between;
            flex-grow: 1;
            margin: 0 10px;
}
        .day {
            position: relative;
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
                .todo-item:hover .todo-buttons, .todo-item.editing .todo-buttons {
            display: inline-block;
        }
        .todo-buttons {
            display: none;
        }
        
        .day:hover {
            background-color: #ffda97;
            border-radius: 6px;
                                    color: #221f1f;
        }
        .active {
            background-color: #ffda97;
            font-weight: bold;
            border-radius: 6px;
                                    color: #221f1f;
        
        }
        .today {
            font-weight: bold;
        }
        .badge {
            position: absolute;
            top: 5px;
            right: 10px;
            background-color: #FF4351;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .todo-container {
            margin-top: 20px;
        
            padding-right: 20px;
        
            padding-left: 20px;
            background-color: #f9f9f9;
            border-radius: 2px; /* 圆角效果 */
            box-shadow: 0 0 0 2px black; /* 模拟 outline */
        }
        /* 新增样式以调整日期选择器的位置 */
        .date-picker-container {
            display: flex;
            align-items: center;
            margin-left: 10px; /* 调整间距 */
        }
        #datePicker {
            display: none; /* 初始隐藏 */
          /* margin-right: 10px;  按钮与日期选择器之间的间距 */
        }
        .todo-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ccc;
            justify-content: space-between;
        }
        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        .todo-text {
            flex-grow: 1;
            color: #131315;
            font-family: sans-serif;
        
        font-size: 16px;
        padding-top: 8px;
            padding-right: 15px;
            padding-bottom: 8px;
            padding-left: 1px;
            margin-right: 10px;
            border: none;
            outline: none;
            background-color: #fff;
        }
        .todo-text[disabled] {
            background-color: #f9f9f9;
        }
        .completed {
            text-decoration: line-through;
            color: #888;
        }
        
        .todo-buttons .delete-confirm {
            background-color: #FF4351 ;
            color: white;
            border-color: #FF4351;
            border: none;
            background: #FF4351;
        }
        
        
        .todo-buttons button {
            animation-name: glowing-primary;
            border-color: #088ef0;
            background: linear-gradient(#34a5f8, #088ef0);
            color: #FFF;
            margin: 2.5px;
            border-style: solid;
            border-width: 1px;
            line-height: 25px;
            border-radius: 4px;
            text-align: center;
            border: none;
        }
        
        .calendar-day.today {
            background-color: #fffeaa; /* 今日的背景 */
            color: black; /* 反色显示 */
            font-size: 12px;
            white-space: nowrap;
        }
        .calendar-nav {
            display: flex;
            justify-content: center; /* 中心对齐 */
            align-items: center;
            padding: 28px; /* 添加内边距 */
            background-color: #fec04e;
            border-radius: 2px; /* 圆角效果 */
            box-shadow: 0 0 0 2px black; /* 模拟 outline */
            color: #221f1f;
            font-weight: bold;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            padding-top: 28px;
            padding-bottom: 28px;
        }
        
        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 七列 */
            grid-template-rows: repeat(autofill, 1fr); /* 行自适应 */
            height: auto; 
        
            gap: 10px; /* 可选，设置格子之间的间距 */
        
        }
        
        .calendar-day {
            border: 1px solid #ddd;
            padding: 10px;
            position: relative;
        font-size: 12px;
            white-space: nowrap;         /* 禁用换行 */
            overflow: hidden;           /* 隐藏溢出的内容 */
        }
        #addTodo {
            width: 100%;
            margin-top: 10px;
            border-radius: 2px; /* 圆角效果 */
            box-shadow: 0 0 0 2px black; /* 模拟 outline */
            padding: 10px 15px;
            background-color: #A5DE37;
            color: black;
            border: none;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
        }
        #addTodo:hover {
            background-color: #b9e563
        }


        #config-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    border-radius: 2px; /* 圆角效果 */
    box-shadow: 0 0 0 2px black; /* 模拟 outline */
    background-color: #fff;
    /*box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);*/
    width: 600px;
    height: 336px; /* 固定高度为600px */
    overflow: hidden; /* 防止内容溢出 */


}

#config-modal label {
    display: block;
    margin-top: 10px;
}

#config-modal .indented-section {
    margin-left: 20px; /* 缩进20px */
}

#save-config {
    position: absolute; /* 绝对定位 */
    bottom: 6px; /* 距离底部10px */
    left: 40%; /* 水平居中 */
    transform: translateX(-50%); /* 通过平移来实现居中 */

    padding: 10px 20px;
    background-color: #A5DE37;
    color: rgb(0, 0, 0);
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    border-radius: 2px; /* 圆角效果 */
    box-shadow: 0 0 0 2px black; /* 模拟 outline */
    font-family: sans-serif;
}

#save-config:hover {
    background-color: #b9e563;
    
}



#exitconfig {
    position: absolute; /* 绝对定位 */
    bottom: 6px; /* 距离底部10px */
    left: 60%; /* 水平居中 */
    transform: translateX(-50%); /* 通过平移来实现居中 */

    padding: 10px 20px;
    background-color: #FF4351;
    color: rgb(0, 0, 0);
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    border-radius: 2px; /* 圆角效果 */
    box-shadow: 0 0 0 2px black; /* 模拟 outline */
    font-family: sans-serif;
}

#exitconfig:hover {
    background-color: #ff7680;
    
}

        
    </style>
</head>
<body>
        <!-- 设置部分 -->
        <div id="config-modal">
            <!-- Main options -->
            <label>ℹ️ Ctrl + / 显示帮助信息</label>
            <label><input type="checkbox" id="md-export"> 启用md文件导出（快捷键 Ctrl + . 下载md文件）</label>
            <label><input type="checkbox" id="new-tab-export"> 启用新标签页导出（快捷键 Ctrl + . 打开新标签页）</label>
            <label><input type="checkbox" id="gist-sync"> 启用Gist上传下载（手动上传快捷键 Ctrl + .  手动下载快捷键 Ctrl + Shift + . ）</label>
            <div id="gist-options" style="display: none;">
                <div class="indented-section">
                    在<a href="https://gist.github.com/">这里</a>创建一个Secret Gist，在<a href="https://github.com/settings/tokens/new">这里</a>创建一个令牌（只用给Gist权限）
                    <label>
                        Gist_地址:
                        <input type="text" style="height: auto;width: 290px;"" id="gist-url" placeholder="https://api.github.com/gists/xxxxxxxxxx">
                    </label>
                    <label>
                        Gist_Token:
                        <input type="text" style="height: auto;width: 280px;" id="gist-token" placeholder="ghp_xxxxxxxxxx">
                    </label>
    
                
                
                <label><input type="checkbox" id="auto-upload"> 启用自动Gist上传（在新设备使用时请先启用Gist上传下载并按下 Ctrl + Shift + . 手动下载Gist内容，避免覆盖线上内容）</label>
                <div class="indented-section">
                    <div id="gist-options2" style="display: none;">
                        <label>
                            自动上传间隔（分钟）:
                            <input type="number" style="height: auto;width: 50px;" id="upload-interval" min="600" placeholder=">=5">
                        </label>
                    </div>
                </div>
            </div>
            </div>
    
    
            
            <!-- Conditional options for gist sync -->
    
    
            <!-- Save and exit button -->
            <button id="save-config">保存并退出</button>
            <button id="exitconfig">退出</button>
        </div>
    
    <!-- 日期导航部分 -->
    <div class="date-nav">
        <div id="yearDisplay" class="year-line"></div> <!-- 显示年份的第一行 -->
        
        <div class="date-line">
            <span class="arrow" id="prevDay">&lt;</span>
            <div class="days" id="daysContainer">
                <!-- 日期将会动态生成 -->
            </div>
            <span class="arrow" id="nextDay">&gt;</span>
        </div>
    </div>

    <!-- 待办列表部分 -->
    <div class="todo-container" id="todoContainer">
        <!-- 待办事项将会在这里生成 -->
    </div>
    <!-- 日历视图部分 -->
    <div id="calendarView" style="display: none;">
        <div class="calendar-nav">
            <span class="arrow" id="prevMonth">&lt;</span>
            <span id="viewLabel">周视图</span>
            <span class="arrow" id="nextMonth">&gt;</span>
        </div>
        <div class="calendar-header">
            <span>周一</span>
            <span>周二</span>
            <span>周三</span>
            <span>周四</span>
            <span>周五</span>
            <span>周六</span>
            <span>周日</span>
        </div>
        <div class="calendar-body" id="calendarBody">
            <!-- 日历天数将会动态生成 -->
        </div>
    </div>
    <button id="chooseDateBtn" style="display: none;">选择日期</button>
    <input type="date" id="datePicker" style="display: none;">
    <button id="addTodo">➕</button>
    <button id="calendarViewBtn">📅日历视图</button>
    <div id="upload-status" class="status"></div>








    <script>
        //var gistUrl = 'https://api.github.com/gists/xxxxxxxxxx'; // 替换为你的 Gist URL，在这里创建一个secret gist： https://gist.github.com/
        //var token = 'ghp_xxxxxxxxxx'; // 替换为你的 GitHub 访问令牌，在这里创建一个令牌，只用给gist权限：https://github.com/settings/tokens/new
            //var backuptab = false; // 设置新标签页文本显示开关
            //var backupgist = false // 设置gist备份开关
            //var backupgistcycle = 120000 // 设置gist自动备份间隔，毫秒单位，小于60秒将不启用自动gist备份
            //var backupmd = false; // 设置md文件备份开关




        // 获取元素
            const chooseDateBtn = document.getElementById('chooseDateBtn');
            const datePicker = document.getElementById('datePicker');
            let editingTodoId = null; // 用于保存当前正在编辑的待办项的ID
        
            // 日期选择按钮事件，点击后弹出日期选择器
            chooseDateBtn.addEventListener('click', () => {
                if (editingTodoId !== null) {
        const todo = todosByDate[currentSelectedDate].find(todo => todo.id === editingTodoId);
        if (todo) {
        if (todo) {
            // 显示日期选择器并设置默认值为当前待办事项的日期
            datePicker.value = currentSelectedDate;
            datePicker.style.display = 'inline-block';
            //datePicker.focus(); // 使日期选择器自动获得焦点
            }
        }
                }
            });
        
                // 监听用户选择日期的事件
            datePicker.addEventListener('change', (event) => {
                const selectedDate = event.target.value;
        
                if (selectedDate && editingTodoId !== null) {
        updateTodoDate(editingTodoId, selectedDate);
                }
                datePicker.style.display = 'none';
            });
        
        
                let currentDate = new Date(); // 当前显示的开始日期
                const daysContainer = document.getElementById("daysContainer");
        
                let todosByDate = {};
                const todoContainer = document.getElementById('todoContainer');
                const addTodoBtn = document.getElementById('addTodo');
                let currentSelectedDate = formatDate(currentDate); // 初始日期
        
                let draggedTodo = null; // 存储被拖动的待办信息
        
                function loadTodos() {
        const storedData = localStorage.getItem('todosByDate');
        if (storedData) {
            todosByDate = JSON.parse(storedData);
        }
                }
        
              function saveTodos() {
            const todosToSave = {};
            let hasValidTodos = false; // 用于跟踪是否存在有效的 todos
        
            for (const date in todosByDate) {
                // 过滤掉空文本的 todos
                const validTodos = todosByDate[date].filter(todo => todo.text.trim() !== '');
                
                if (validTodos.length > 0) {
        hasValidTodos = true; // 如果有有效的 todos，则标记为 true
        todosToSave[date] = validTodos.map(todo => ({
            id: todo.id,
            text: todo.text,
            completed: todo.completed
            // 不再保存 editing 和 deleteConfirmed
        }));
                }
            }
        
            // 只有在有有效 todos 的情况下才保存到 localStorage
            if (hasValidTodos) {
                localStorage.setItem('todosByDate', JSON.stringify(todosToSave));
        
            } else {
                // 如果没有有效的 todos，则清空 localStorage
                localStorage.removeItem('todosByDate');
        
            }
        }
        
                function formatDate(date) {
        const offsetDate = new Date(date.getTime() + (8 * 60 * 60 * 1000)); // Offset for GMT+8
        return offsetDate.toISOString().split('T')[0]; // 返回 YYYY-MM-DD 格式
                }
        
                // 生成7天的日期显示 (始终以周一为开始)
                function updateDays() {
    daysContainer.innerHTML = '';

        // 设置年份显示
        const yearDisplay = document.getElementById("yearDisplay");
    yearDisplay.textContent = "🧭"+currentDate.getFullYear(); // 获取当前显示年份并更新
    
    const dayOfWeek = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    let tempDate = new Date(currentDate);
    const dayOffset = tempDate.getDay() === 0 ? 6 : tempDate.getDay() - 1;
    tempDate.setDate(tempDate.getDate() - dayOffset); // 回到周一

    for (let i = 0; i < 7; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        const formattedDate = formatDate(tempDate);

        dayDiv.innerHTML = `${dayOfWeek[tempDate.getDay()]}<br>${tempDate.getMonth() + 1}-${tempDate.getDate()}`;
        dayDiv.setAttribute("data-date", formattedDate);

        const pendingTodos = (todosByDate[formattedDate] || []).filter(todo => !todo.completed).length;
        if (pendingTodos > 0) {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = pendingTodos;
            dayDiv.appendChild(badge);
        }

        dayDiv.addEventListener('dragover', (e) => e.preventDefault());
        dayDiv.addEventListener('drop', (e) => handleDrop(e, formattedDate));
        dayDiv.addEventListener('click', (e) => {
            const selectedDate = e.target.getAttribute("data-date");
            Array.from(daysContainer.children).forEach(d => d.classList.remove('active'));
            e.target.classList.add('active');

            showTodoList(selectedDate);
        });

        // 重新检查今天日期的标记
        if (formattedDate === formatDate(new Date())) {
            dayDiv.classList.add('today');
        }

        // 确保新选择的日期高亮显示
        if (formattedDate === currentSelectedDate) {
            dayDiv.classList.add('active');
        }

        daysContainer.appendChild(dayDiv);
        tempDate.setDate(tempDate.getDate() + 1);
    }
}

        
                function showTodoList(date) {
        currentSelectedDate = date;
        
        renderTodoList();
                }
        
                function renderTodoList() {
        todoContainer.innerHTML = '';
        const todos = todosByDate[currentSelectedDate] || [];
        
        const uncompletedTodos = todos.filter(todo => !todo.completed);
        const completedTodos = todos.filter(todo => todo.completed);
        
        uncompletedTodos.forEach(todo => createTodoElement(todo));
        completedTodos.forEach(todo => createTodoElement(todo));
            // 聚焦到最后一个新增的或正在编辑的待办
            const editingTodo = todos.find(todo => todo.editing);
            if (editingTodo) {
                const inputField = Array.from(todoContainer.children).find(item => item.querySelector('.todo-text').value === editingTodo.text);
                if (inputField) {
        inputField.querySelector('.todo-text').focus();
        
        
                }
            } else {
                const lastTodo = Array.from(todoContainer.children).slice(-1)[0];
                if (lastTodo) {
        lastTodo.querySelector('.todo-text').focus();
                }
            }
        
        updateDays();
        saveTodos();
                }
        
                function createTodoElement(todo) {
        const todoElement = document.createElement('div');
        todoElement.className = 'todo-item';
        todoElement.setAttribute('draggable', true);
        todoElement.addEventListener('dragstart', () => handleDragStart(todo));
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'todo-checkbox';
        checkbox.checked = todo.completed;
        checkbox.addEventListener('click', () => toggleComplete(todo.id));
        todoElement.appendChild(checkbox);
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'todo-text';
        input.value = todo.text;
        input.disabled = !todo.editing;
        if (todo.completed) input.classList.add('completed');
        input.addEventListener('dblclick', () => editTodoText(todo.id)); // 双击进入编辑模式
        todoElement.appendChild(input);
        
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'todo-buttons';
        
        if (todo.editing) {
            todoElement.classList.add('editing');
                        todoElement.setAttribute('draggable', false);
        
            // 创建选择日期按钮
            const chooseDateBtn = document.createElement('button');
            chooseDateBtn.textContent = '选择日期';
        // 新增日期选择器容器
                const datePickerContainer = document.createElement('div');
                datePickerContainer.className = 'date-picker-container';
            // 选择日期按钮的点击事件
            chooseDateBtn.addEventListener('click', () => {
                // 显示日期选择器并设置默认值为当前待办事项的日期
                datePicker.value = currentSelectedDate; // 使用当前选定的日期
                datePicker.style.display = 'inline-block'; // 显示日期选择器
                //datePicker.focus(); // 聚焦到日期选择器
                chooseDateBtn.style.display = 'none'; 
        
        
        
              // 遍历所有按钮，查找文本为“确定”的按钮      
        const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
        if (button.textContent.trim() === '确定' || button.textContent.trim() === '删除') {
            button.style.display = 'none'; 
        
        }
            });  
        
        
            });
        
                // 将日期选择器和按钮添加到容器中
                datePickerContainer.appendChild(datePicker);
                datePickerContainer.appendChild(chooseDateBtn);
                buttonContainer.appendChild(datePickerContainer); 
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '确定';
            saveBtn.addEventListener('click', () => saveTodoText(todo.id, input.value));
        
            buttonContainer.appendChild(saveBtn);
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    saveTodoText(todo.id, input.value);
                }
            });
            input.focus(); // 自动聚焦
        } else {
            const editBtn = document.createElement('button');
            editBtn.textContent = '编辑';
            editBtn.addEventListener('click', () => {
                editTodoText(todo.id);
                input.focus(); // 编辑时自动聚焦到输入框
            });
        
        
        datePicker.addEventListener('change', (event) => {
            const selectedDate = event.target.value;
        
            if (selectedDate && editingTodoId !== null) {
                updateTodoDate(editingTodoId, selectedDate); // 更新待办事项的日期
        
            }
            datePicker.style.display = 'none'; // 隐藏日期选择器
        });                
            buttonContainer.appendChild(editBtn);
        
        }
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = todo.deleteConfirmed ? '确认删除' : '删除';
        datePicker.style.display = 'none';
        
        deleteBtn.classList.toggle('delete-confirm', todo.deleteConfirmed);
        deleteBtn.addEventListener('click', () => {
        
            confirmDelete(todo.id);
        
           const buttons = document.querySelectorAll('button');
            // 遍历所有按钮，查找文本为“确定”的按钮
            buttons.forEach(button => {
                if (button.textContent.trim() === '选择日期') {
        button.style.display = 'none'; 
                }
            });  
        
        
        });
        
        // 添加 mouseenter 和 mouseleave 事件监听器
        deleteBtn.addEventListener('mouseenter', () => {
            if (todo.deleteConfirmed) {
                deleteBtn.textContent = '确认删除'; // 鼠标悬停时保持确认删除
            }
        });
        
        deleteBtn.addEventListener('mouseleave', () => {
            deleteBtn.textContent = '删除'; // 鼠标移开时恢复文本
                todo.deleteConfirmed=false;
        });
        
        buttonContainer.appendChild(deleteBtn);
        
        todoElement.appendChild(buttonContainer);
        todoContainer.appendChild(todoElement);
                }
        
                function handleDragStart(todo) {
            const currentDateElement = document.querySelector('.calendar-day.active'); // 获取当前选中日期的元素
            const currentDate = currentDateElement ? currentDateElement.getAttribute('data-date') : currentSelectedDate; // 获取当前选中日期
            draggedTodo = { ...todo, sourceDate: currentDate }; // 将当前日期设置为源日期
                }
        
              function handleDrop(event, targetDate) {
            event.preventDefault(); // 防止默认行为
        
            if (draggedTodo) {
                // 从原日期中删除
                todosByDate[draggedTodo.sourceDate] = todosByDate[draggedTodo.sourceDate].filter(todo => todo.id !== draggedTodo.id);
                // 添加到目标日期
                todosByDate[targetDate] = todosByDate[targetDate] || [];
                todosByDate[targetDate].push(draggedTodo);
        
                // 更新当前选中日期的待办列表
                if (currentSelectedDate === draggedTodo.sourceDate || currentSelectedDate === targetDate) {
        renderTodoList();
                }
        
                draggedTodo = null; // 清空被拖动的待办信息
                saveTodos();
                updateDays();
                renderCalendar(); // 重新渲染日历
        
            }
        }
        
        
                function addNewTodo() {
        const newTodo = {
            id: Date.now(),
            text: '',
            completed: false,
            editing: true,
            deleteConfirmed: false
        };
        // 不将空的新增待办存储
        todosByDate[currentSelectedDate] = todosByDate[currentSelectedDate] || [];
        todosByDate[currentSelectedDate].push(newTodo);
        datePicker.style.display = 'none';
        
        renderTodoList();
        
        const inputFields = document.querySelectorAll('.todo-text');
        inputFields[inputFields.length - 1].focus(); // 光标自动聚焦
        
        
        const buttons = document.querySelectorAll('button');
            // 遍历所有按钮，查找文本为“确定”的按钮
            buttons.forEach(button => {
                if (button.textContent.trim() === '选择日期') {
        button.style.display = 'none'; 
                }
            });  
        
                
        
        
                }
        
                function toggleComplete(id) {
        todosByDate[currentSelectedDate] = todosByDate[currentSelectedDate].map(todo => {
            if (todo.id === id) {
                todo.completed = !todo.completed;
            }
            return todo;
        });
        renderTodoList();
                }
        
                function saveTodoText(id, newText) {
            todosByDate[currentSelectedDate] = todosByDate[currentSelectedDate].map(todo => {
                if (todo.id === id) {
        if (!newText.trim()) {
            return null; // 如果文本为空，则删除待办
        }
        todo.text = newText;
        // 不再保存 editing 状态
        todo.editing = false;
                }
                return todo;
            }).filter(todo => todo !== null); // 过滤掉空文本的待办
            renderTodoList();
        chooseDateBtn.style.display = 'none'; // 隐藏 "选择日期" 按钮
                editingTodoId = null; // 清空编辑中的ID
                }
        
                function editTodoText(id) {
            todosByDate[currentSelectedDate] = todosByDate[currentSelectedDate].map(todo => {
                if (todo.id === id) {
        todo.editing = true;
        editingTodoId = id; // 保存正在编辑的待办ID
                }
                return todo;
            });
        
            chooseDateBtn.style.display = 'none'; // 显示 "选择日期" 按钮
            renderTodoList();
                }
         function updateTodoDate(id, newDate) {
        
                // 从当前日期移除该待办事项
                const todo = todosByDate[currentSelectedDate].find(todo => todo.id === id);
                if (todo) {
        // 从当前日期移除该待办事项
        todosByDate[currentSelectedDate] = todosByDate[currentSelectedDate].filter(todo => todo.id !== id);
        // 将待办事项添加到新日期
        todosByDate[newDate] = todosByDate[newDate] || [];
        todosByDate[newDate].push(todo);
        currentSelectedDate = newDate; // 更新当前选中的日期



// 检查新日期是否在当前周内
const selectedDateObj = new Date(newDate);
        const startOfWeek = new Date(currentDate);
        const dayOffset = startOfWeek.getDay() === 0 ? 6 : startOfWeek.getDay() - 1;
        startOfWeek.setDate(startOfWeek.getDate() - dayOffset);  // 当前周的起始日期

        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6);  // 当前周的结束日期

        if (selectedDateObj < startOfWeek || selectedDateObj > endOfWeek) {
            // 如果新日期不在当前显示的周内，更新currentDate为新日期所在周的起始
            currentDate = new Date(selectedDateObj);
            currentDate.setDate(currentDate.getDate() - (currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1));
        }








        updateDays();
        renderTodoList();
          const buttons = document.querySelectorAll('button');
        
            // 遍历所有按钮，查找文本为“确定”的按钮
            buttons.forEach(button => {
                if (button.textContent.trim() === '确定') {
        button.click(); // 点击按钮
                }
            });  
        
                }
                chooseDateBtn.style.display = 'none'; // 隐藏 "选择日期" 按钮
                editingTodoId = null; // 清空编辑中的ID
            }
                function confirmDelete(id) {
                
        
        todosByDate[currentSelectedDate] = todosByDate[currentSelectedDate].map(todo => {
        
            if (todo.id === id) {
                if (todo.deleteConfirmed) {
                    return null;
                    
                }
                todo.deleteConfirmed = true;
            }
        
            return todo;
        }).filter(todo => todo !== null);
        
        
        renderTodoList();
                }
        
                document.getElementById("prevDay").addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 7);
        updateDays();
                });
        
                document.getElementById("nextDay").addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 7);
        updateDays();
                });
        
                addTodoBtn.addEventListener('click', addNewTodo);
        
                function moveUncompletedTodosToToday() {
        const today = formatDate(new Date());
        for (let date in todosByDate) {
            if (date < today) {
                const uncompletedTodos = todosByDate[date].filter(todo => !todo.completed);
                if (uncompletedTodos.length > 0) {
                    todosByDate[today] = (todosByDate[today] || []).concat(uncompletedTodos);
                    todosByDate[date] = todosByDate[date].filter(todo => todo.completed);
                }
            }
        }
                }
        
                loadTodos();
                moveUncompletedTodosToToday();
                updateDays();
                renderTodoList();
        
        
        
        
        let isCalendarView = false; // 跟踪是否在日历视图中
        const calendarViewBtn = document.getElementById("calendarViewBtn");
        const calendarBody = document.getElementById("calendarBody");
        const viewLabel = document.getElementById("viewLabel");
        
        calendarViewBtn.addEventListener('click', toggleCalendarView);
        document.getElementById("prevMonth").addEventListener('click', () => changeMonth(-1));
        document.getElementById("nextMonth").addEventListener('click', () => changeMonth(1));
        
        function toggleCalendarView() {
            isCalendarView = !isCalendarView;
            document.getElementById("todoContainer").style.display = isCalendarView ? 'none' : 'block';
            document.getElementById("calendarView").style.display = isCalendarView ? 'block' : 'none';
        // 控制日期导航的显示与隐藏
            document.querySelector('.date-nav').style.display = isCalendarView ? 'none' : 'flex';
                calendarViewBtn.textContent = isCalendarView ? '🕔️周视图' : '📅日历视图';
        const addTodoButton = document.getElementById("addTodo");
            addTodoButton.style.display = isCalendarView ? 'none' : 'block';
        
        
            if (isCalendarView) {
                renderCalendar();
            }
        
                if (!isCalendarView) {
                //location.reload(); // Reloads the current page
                currentSelectedDate = formatDate(currentDate); // 设置当前选中日期为当前日期
                            updateDays();
            renderTodoList()
                //renderTodoList();  渲染待办事项列表
                //renderCalendar();
            }
        }
        
        let currentMonth = new Date(); // 当前显示的月份
        
        function changeMonth(direction) {
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            renderCalendar();
        }
        function updateViewLabel(year, month) {
            const viewLabel = document.getElementById("viewLabel");
            viewLabel.textContent = `${year}年${month}月`;
        }
        
        
        function renderCalendar() {  
            calendarBody.innerHTML = '';
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const now = new Date();
            updateViewLabel(year, month+1);
        
            // 获取当月第一天
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0); // 获取上个月最后一天
            const startDay = firstDay.getDay(); // 周几开始
        
        
            // 添加前置空格
            for (let i = 1; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                calendarBody.appendChild(emptyDay);
            }
        
            // 添加每一天的数字
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
        
                // 标记今天
                if (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
        dayDiv.classList.add('today');
                }
        
                // 添加待办事项
        const formattedDate = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const todos = todosByDate[formattedDate] || [];
        todos.forEach(todo => {
            const todoText = document.createElement('div');
            todoText.textContent = `· ${todo.text}`; // 添加符号
            if (todo.completed) {
                todoText.classList.add('completed');
            }
         // 设置为可拖动
        
        todoText.setAttribute('draggable', true);
        
        
        
        
        
        
        
        
        
        let isDragging = false;
        let clickCount = 0; // 记录点击次数
        
        todoText.addEventListener('dragstart', (e) => {
            isDragging = true; // 设置拖动标志
        
            handleDragStart(todo); // 拖动开始
        });
        
        dayDiv.addEventListener('mousedown', () => {
            clickCount = 0; // 重置点击次数
            currentSelectedDate = formattedDate; // 更新当前选中日期
        
            renderCalendar(); // 重新渲染日历以高亮显示选中日期
        });
        
        todoText.addEventListener('mousedown', () => {
            clickCount++; // 增加点击次数
        
            if (clickCount === 2) { // 检测双击
        
                if (!isDragging) { // 如果没有拖动，执行双击事件
        toggleComplete(todo.id); // 切换任务状态
        renderCalendar(); // 更新日历视图
                }
                clickCount = 0; // 重置点击次数
            }
        });
        
        // 拖动结束时重置拖动标志
        todoText.addEventListener('dragend', () => {
            isDragging = false; // 重置拖动状态
        });
        
        
        
        
        
        
        
        
        
            // 更新 currentSelectedDate
        
        dayDiv.appendChild(todoText);
                });
        
        
        
            // 更新当前选中日期
        
        
        
        
        
                dayDiv.setAttribute("data-date", formattedDate);
                dayDiv.addEventListener('dragover', (e) => e.preventDefault());
                dayDiv.addEventListener('drop', (e) => handleDrop(e, formattedDate));
                calendarBody.appendChild(dayDiv);
            }
        }
function backupmdornewtab() {
    
                const todosByDate = JSON.parse(localStorage.getItem('todosByDate'));
                let output = '';
 // 获取日期并排序
        const sortedDates = Object.keys(todosByDate).sort((a, b) => new Date(a) - new Date(b));
        
 // 遍历排序后的日期
        for (const date of sortedDates) {
            output += `## ${date}\n\n`;
            const todos = todosByDate[date];
            todos.forEach(todo => {
                const completedMarker = todo.completed ? '[x]' : '[ ]';
                output += `- ${completedMarker} ${todo.text}\n`;
            });
            output += '\n'; // 添加空行以分隔日期
        }


           if (globalConfig.backuptab){
                const newTab = window.open();
                newTab.document.write('<pre>' + output.trim() + '</pre>');
                newTab.document.close(); // 关闭文档流以完成页面加载
                    }

           if (globalConfig.backupmd) {
        const today = new Date().toISOString().split('T')[0]; // 获取今日日期
        const blob = new Blob([output.trim()], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `备份于${today}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }


}     
function backup2gist() {
    const todosByDate = JSON.parse(localStorage.getItem('todosByDate'));
                let output = '';
 // 获取日期并排序
        const sortedDates = Object.keys(todosByDate).sort((a, b) => new Date(a) - new Date(b));
        
 // 遍历排序后的日期
        for (const date of sortedDates) {
            output += `## ${date}\n\n`;
            const todos = todosByDate[date];
            todos.forEach(todo => {
                const completedMarker = todo.completed ? '[x]' : '[ ]';
                output += `- ${completedMarker} ${todo.text}\n`;
            });
            output += '\n'; // 添加空行以分隔日期
        }


    if (globalConfig.backupgist) {
            syncToGist(output.trim());
            console.log("开始备份")
        }
    
    

}
        document.addEventListener('keydown', function(event) {






            if (event.ctrlKey && event.key === '.' ) {

                backupmdornewtab();
                backup2gist();

            } else if (event.ctrlKey && event.key === '/') {
                const helpTab = window.open();
                helpTab.document.write(`
        <html>
            <head>
                <title>使用说明</title>
                
        
        
            </head>
            <body>
                <h1>使用说明</h1>
                <p>1. 点击日期可以切换日期，点击<>可以切换上一周、下一周</p>
                <p>2. 点击+新增待办</p>
                <p>3. 点击编辑按钮修改待办内容</p>
                <p>4. 点击选择日期，可以将任务移动到其他日期</p>
                <p>5. 可以拖动任务到其他日期</p>
                <p>6. 前期未完成的任务会自动转移到今天，已完成的不会转移</p>
                <p>7. 点击日历视图可以看整个月已完成、未完成的任务</p>
                <p>8. 日历视图下，可以拖动改变任务日期</p>
                <p>9. ctrl+. 可以以markdown格式导出所有任务、上传Gist备份，在新标签页显示所有任务</p>
                <p>10. ctrl+/ 可以显示说明 </p>
                <p>11. ctrl+, 可以导入任务（格式必须同9导出的） </p>
            </body>
        </html>
                `);
                helpTab.document.close(); // 关闭文档流以完成页面加载
            }
        });
        
        
        
        // 监听键盘事件
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === ',') {
                // 弹出输入框
                const userInput = prompt("请输入待办事项：");
                if (userInput) {
        importTodos(userInput);
                }
            }
        });


        document.addEventListener('keydown', function(event) {
    if (event.ctrlKey  && event.key === '>' && globalConfig.backupgist === true) {
        // 读取 Gist 内容
        fetchGistContent();
    }
})


        
        function importTodos(input) {
            const todosByDate = {};
            let currentId = 1;
        
            // 按行分割输入内容
            const lines = input.split('\n');
        
            let currentDate = '';
        
            lines.forEach(line => {
                line = line.trim();
                // 匹配日期
                const dateMatch = line.match(/^## (\d{4}-\d{2}-\d{2})$/);
                if (dateMatch) {
        currentDate = dateMatch[1];
        todosByDate[currentDate] = [];
                }
                // 匹配待办事项
                const todoMatch = line.match(/^- \[(x| )\] (.+)$/);
                if (todoMatch && currentDate) {
        const completed = todoMatch[1] === 'x';
        const text = todoMatch[2];
        
        // 添加待办事项（忽略 ID）
        todosByDate[currentDate].push({
            id: currentId++, // 生成新 ID
            text: text,
            completed: completed
        });
                }
            });
        
            // 存储到 localStorage
            localStorage.setItem('todosByDate', JSON.stringify(todosByDate));
            console.log('待办事项已导入:', todosByDate);

            //location.reload();
        }


        
function syncToGist(content) {
    const statusElement = document.getElementById('upload-status'); // 获取状态元素
    const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
    statusElement.textContent = `${currentTime} ⏫正在将数据上传Gist`; // 设置初始状态

    fetch(globalConfig.gistUrl, {
        method: 'PATCH',
        headers: {
            'Authorization': `token ${globalConfig.token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            files: {
                'todos.md': {
                    content: content
                }
            }
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to sync with Gist');
        }
        return response.json();
    })
    .then(data => {
        const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
        statusElement.textContent = `${currentTime} ✅ Gist上传成功`; // 显示成功状态
        //setTimeout(() => {
        //statusElement.textContent = ''; // 10秒后清空状态
        //}, 5000); // 10000毫秒 = 10秒
        console.log('Gist updated:', data.html_url);
    })
    .catch(error => {
        const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
        statusElement.textContent = `${currentTime} ❌ Gist上传失败，请检查设置`; // 显示失败状态
        console.error('Error syncing with Gist:', error);
    });
}


// 从 Gist 获取内容的函数
function fetchGistContent() {
    const statusElement = document.getElementById('upload-status'); // 获取状态元素
    const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
    
    statusElement.textContent = `${currentTime} ⏬正在从Gist下载数据`; // 设置初始状态
    fetch(globalConfig.gistUrl, {
        method: 'GET', // 指定请求方法
        headers: {
            'Authorization': `token ${globalConfig.token}`
        },
        cache: 'no-cache' // 忽略缓存，强制请求最新数据
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch Gist content');
            statusElement.textContent = `${currentTime} ❌ Gist下载失败，请检查设置`; // 
        }
        return response.json();
    })
    .then(data => {
        const content = data.files['todos.md'].content; // 获取文件内容
        console.log('Fetched content from Gist:', content); // 输出内容
        importTodos(content)
        const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
        statusElement.textContent = `${currentTime} ✅从Gist读取成功`; // 显示失败状态
        loadTodos();
        renderTodoList();
        setTimeout(() => {
        statusElement.textContent = ''
        }, 5000); // 10000毫秒 = 10秒
    })
    .catch(error => {
        console.error('Error fetching Gist content:', error);
        statusElement.textContent = `${currentTime} ❌ Gist下载失败，请检查设置`; // 
    });
}


// 定义一个全局变量来存储配置
let globalConfig = {};

// 函数用于从 localStorage 读取配置
function loadConfig() {
    // 从 localStorage 中获取 config 字符串
    const configString = localStorage.getItem('config');



    // 检查是否成功获取到配置
    if (configString) {
        try {
            // 解析 JSON 字符串为对象
            const configObject = JSON.parse(configString);

            // 将配置对象赋值给全局变量
            globalConfig = {
                backupgist: configObject.gistSync || false,
                backuptab : configObject.newTabExport || false,
                backupmd: configObject.mdExport || false,
                autoUpload: configObject.autoUpload || false,
                backupgistcycle: configObject.uploadInterval || '',
                gistUrl: configObject.gistUrl || '',
                token: configObject.gistToken || '',
            };

            console.log('配置加载成功:', globalConfig);
    document.getElementById('gist-sync').checked = globalConfig.backupgist;
    document.getElementById('new-tab-export').checked = globalConfig.backuptab;
    document.getElementById('md-export').checked = globalConfig.backupmd;
    document.getElementById('auto-upload').checked = globalConfig.autoUpload;
    document.getElementById('upload-interval').value = globalConfig.backupgistcycle;
    document.getElementById('gist-url').value = globalConfig.gistUrl;
    document.getElementById('gist-token').value = globalConfig.token;
        } catch (error) {
            console.error('解析配置时出错:', error);
        }
    } else {
        console.warn('未找到配置项');
    }
}

window.onload = function() {
    loadConfig();
    const statusElement = document.getElementById('upload-status'); // 获取状态元素
    

      if (globalConfig.backupgistcycle >= 5 && globalConfig.autoUpload === true ) {

        const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
        statusElement.textContent = `${currentTime} 🔁已启用自动上传Gist（间隔 ${globalConfig.backupgistcycle} 分钟，5s后开始第一次上传） `; // 设置初始状态
        setTimeout(() => {
            backup2gist();
        }, 5000); // 10000毫秒 = 10秒

        setInterval(backup2gist, globalConfig.backupgistcycle*60000);
      } else {
        const currentTime = new Date().toLocaleTimeString(); // 获取当前时间
        statusElement.textContent = `${currentTime} ℹ️未启用自动上传Gist，请定期手动备份（按 Ctrl + Shift + ? 配置备份方式）`; // 设置初始状态
        //setTimeout(() => {
        //statusElement.textContent = ''; // 10秒后清空状态
        //}, 5000); // 10000毫秒 = 10秒
      }

    };



//设置功能部分



document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === '?') {
            document.getElementById('config-modal').style.display = 'block';
            document.getElementById('gist-options').style.display = globalConfig.backupgist ? 'block' : 'none';
            document.getElementById('gist-options2').style.display = globalConfig.autoUpload ? 'block' : 'none';

        }
    });


    // 根据选项的初始状态设置相应的显示状态


    // Toggle gist options visibility
    document.getElementById('gist-sync').addEventListener('change', function() {
        document.getElementById('gist-options').style.display = this.checked ? 'block' : 'none';

    });

    document.getElementById('auto-upload').addEventListener('change', function() {
        document.getElementById('gist-options2').style.display = this.checked ? 'block' : 'none';

    });

    // Save configuration to localStorage
    document.getElementById('save-config').addEventListener('click', () => {
        const config = {
            gistSync: document.getElementById('gist-sync').checked,
            newTabExport: document.getElementById('new-tab-export').checked,
            mdExport: document.getElementById('md-export').checked,
            autoUpload: document.getElementById('auto-upload').checked,
            uploadInterval: parseInt(document.getElementById('upload-interval').value, 10) || null,
            gistUrl: document.getElementById('gist-url').value || '',
            gistToken: document.getElementById('gist-token').value || ''
        };

        // Save config to localStorage
        localStorage.setItem('config', JSON.stringify(config));
        
        // Refresh the page
        window.location.reload();
    });

    document.getElementById('exitconfig').addEventListener('click', () => {
        document.getElementById('config-modal').style.display = 'none';
    });


        
    </script>
</body>
</html>